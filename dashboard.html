<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- Chart.js v4 with date-fns adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
</head>

<body>
  <section class="section" style="max-width: 700px; margin-top: 60px;">
    <div class="container">
      <h2>Welcome to Your Fitness Dashboard</h2>

      <!-- ðŸ”¹ Summary Card -->
      <div class="dashboard-card" id="summary-card" style="display: none;">
        <h3>Summary</h3>
        <p><strong>Name:</strong> <span id="summary-name"></span></p>
        <p><strong>Goal:</strong> <span id="summary-goal"></span></p>
        <p><strong>Weight Progress:</strong>
          <span id="summary-weight"></span>
        </p>
      </div>

      <!-- ðŸ”§ Editable Profile Form -->
      <form id="profile-form">
        <p><strong>Email:</strong> <span id="user-email"></span></p>
        <label for="fullName">Full Name</label>
        <input type="text" id="fullName" required />

        <label for="goal">Goal</label>
        <input type="text" id="goal" />

        <label for="startDate">Goal Start Date</label>
        <input type="date" id="startDate" />

        <label for="currentWeight">Current Weight (kg)</label>
        <input type="number" id="currentWeight" step="0.1" />

        <label for="targetWeight">Target Weight (kg)</label>
        <input type="number" id="targetWeight" step="0.1" />

        <label for="notes">Notes</label>
        <textarea id="notes"></textarea>

        <button type="submit" class="btn-primary">ðŸ’¾ Save Changes</button>
        <p id="responseMsg"></p>
      </form>
      <br>
      <!-- ðŸ“ˆ Progress Graph -->
      <div class="dashboard-card">
        <h3>Progress Graph</h3>
          <canvas id="progressChart" width="400" height="200"></canvas>
      </div>

      <button id="logoutBtn" class="btn-secondary">ðŸšª Log out</button>
    </div>
  </section>

<div class="photo-upload-section">
  <h3>ðŸ“¸ Upload Progress Photos</h3>
  <input type="file" id="photoInput" accept="image/*" />
  <button id="uploadPhotoBtn" class="btn-primary">Upload Photo</button>
  <p id="uploadStatus"></p>
  <div id="photoGallery"></div>
</div>



<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    collection,
    addDoc,
    getDocs,
    Timestamp
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
  import {
    getStorage,
    ref as storageRef,
    uploadBytes,
    getDownloadURL,
    listAll
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDpju8JIedURVxBJgmZ1yBuRzd4CEdFDVY",
    authDomain: "carleynfitnesscalendar.firebaseapp.com",
    projectId: "carleynfitnesscalendar",
    storageBucket: "carleynfitnesscalendar.appspot.com",
    messagingSenderId: "1013642078015",
    appId: "1:1013642078015:web:e8bcff9d1559f1c1d5158a"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const form = document.getElementById("profile-form");
  const responseMsg = document.getElementById("responseMsg");
  const logoutBtn = document.getElementById("logoutBtn");

  const summaryCard = document.getElementById("summary-card");
  const userEmailDisplay = document.getElementById("user-email");

  const summaryName = document.getElementById("summary-name");
  const summaryGoal = document.getElementById("summary-goal");
  const summaryWeight = document.getElementById("summary-weight");

  const chartCanvas = document.getElementById("progressChart")?.getContext("2d");
  let progressChart;

  const photoInput = document.getElementById("photoInput");
  const uploadPhotoBtn = document.getElementById("uploadPhotoBtn");
  const uploadStatus = document.getElementById("uploadStatus");
  const photoGallery = document.getElementById("photoGallery");

  async function loadProgressData(uid) {
    const progressRef = collection(db, "clients", uid, "progress");
    const snapshot = await getDocs(progressRef);
    const data = [];

    snapshot.forEach(doc => {
      const entry = doc.data();
      if (entry.date && entry.weight) {
        data.push({
          x: new Date(entry.date.seconds * 1000),
          y: entry.weight
        });
      }
    });

    data.sort((a, b) => a.x - b.x);
    return data;
  }

  async function renderGraph(uid) {
    if (!chartCanvas || typeof Chart === "undefined") return;
    const data = await loadProgressData(uid);

    if (progressChart) progressChart.destroy();

    progressChart = new Chart(chartCanvas, {
      type: 'line',
      data: {
        datasets: [{
          label: 'Weight (kg)',
          data: data,
          borderColor: '#ff6384',
          backgroundColor: '#ffe5ec',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        scales: {
          x: {
            type: 'time',
            time: { unit: 'week' },
            title: { display: true, text: 'Date' }
          },
          y: {
            title: { display: true, text: 'Weight (kg)' }
          }
        }
      }
    });
  }

  async function loadPhotos(uid) {
    photoGallery.innerHTML = "";
    const listRef = storageRef(storage, `clients/${uid}/photos`);
    try {
      const res = await listAll(listRef);
      for (const item of res.items) {
        const url = await getDownloadURL(item);
        const img = document.createElement("img");
        img.src = url;
        img.alt = "Progress photo";
        img.style.maxWidth = "120px";
        img.style.borderRadius = "6px";
        img.style.margin = "8px";
        photoGallery.appendChild(img);
      }
    } catch (err) {
      console.warn("No photos yet:", err.message);
    }
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    userEmailDisplay.textContent = user.email;
    const docRef = doc(db, "clients", user.uid);
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
      const data = docSnap.data();

      document.getElementById("fullName").value = data.fullName || "";
      document.getElementById("goal").value = data.goal || "";
      document.getElementById("startDate").value = data.startDate || "";
      document.getElementById("currentWeight").value = data.currentWeight || "";
      document.getElementById("targetWeight").value = data.targetWeight || "";
      document.getElementById("notes").value = data.notes || "";

      summaryCard.style.display = "block";
      summaryName.textContent = data.fullName || "Unknown";
      summaryGoal.textContent = data.goal || "None";

      if (data.currentWeight && data.targetWeight) {
        const diff = (data.currentWeight - data.targetWeight).toFixed(1);
        summaryWeight.textContent = `${data.currentWeight}kg â†’ ${data.targetWeight}kg (${diff}kg to go)`;
      } else {
        summaryWeight.textContent = "N/A";
      }
    }

    await renderGraph(user.uid);
    await loadPhotos(user.uid);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const profile = {
        fullName: summaryName.textContent,
        email: user.email,
        goal: document.getElementById("goal").value.trim(),
        startDate: document.getElementById("startDate").value,
        currentWeight: parseFloat(document.getElementById("currentWeight").value),
        targetWeight: parseFloat(document.getElementById("targetWeight").value),
        notes: document.getElementById("notes").value.trim()
      };

      try {
        await setDoc(docRef, profile);
        await addDoc(collection(db, "clients", user.uid, "progress"), {
          weight: profile.currentWeight,
          date: Timestamp.now()
        });

        responseMsg.style.color = "green";
        responseMsg.textContent = "âœ… Profile updated!";
        await renderGraph(user.uid);
      } catch (err) {
        console.error(err);
        responseMsg.style.color = "red";
        responseMsg.textContent = "âŒ Error saving profile.";
      }
    });

    uploadPhotoBtn.addEventListener("click", async () => {
      if (!photoInput.files.length) return;
      const file = photoInput.files[0];
      const fileRef = storageRef(storage, `clients/${user.uid}/photos/${Date.now()}_${file.name}`);

      try {
        await uploadBytes(fileRef, file);
        uploadStatus.textContent = "âœ… Photo uploaded!";
        uploadStatus.style.color = "green";
        await loadPhotos(user.uid);
      } catch (err) {
        console.error(err);
        uploadStatus.textContent = "âŒ Upload failed.";
        uploadStatus.style.color = "red";
      }
    });
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "index.html";
  });
</script>




</body>
</html>
