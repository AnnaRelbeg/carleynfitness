<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="images/CNF_Dashboard.png" type="image/png">
  <!-- Chart.js v4 with date-fns adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/glightbox/3.2.0/css/glightbox.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/glightbox/3.2.0/js/glightbox.min.js"></script>

</head>

<body>
  <section class="section" style="max-width: 700px; margin-top: 60px;">
    <div class="container">
      <h2>Welcome to Your Fitness Dashboard</h2>

      <!-- üîπ Summary Card -->
      <div class="dashboard-card" id="summary-card" style="display: none;">
        <h3>Summary</h3>
        <p><strong>Name:</strong> <span id="summary-name"></span></p>
        <p><strong>Goal:</strong> <span id="summary-goal"></span></p>
        <p><strong>Weight Progress:</strong>
          <span id="summary-weight"></span>
        </p>
      </div>

      <!-- üîß Editable Profile Form -->
      <form id="profile-form">
        <p><strong>Email:</strong> <span id="user-email"></span></p>
        <label for="fullName">Full Name</label>
        <input type="text" id="fullName" readonly />

        <label for="goal">Goal</label>
        <input type="text" id="goal" />

        <label for="startDate">Goal Start Date</label>
        <input type="date" id="startDate" />

        <label for="currentWeight">Current Weight (kg)</label>
        <input type="number" id="currentWeight" step="0.1" />

        <label for="targetWeight">Target Weight (kg)</label>
        <input type="number" id="targetWeight" step="0.1" />

        <label for="waist">Waist Circumference (cm)</label>
        <input type="number" id="waist" step="0.1" />

        <label for="notes">Notes</label>
        <textarea id="notes"></textarea>

        <button type="submit" class="btn-primary">üíæ Save Changes</button>
        <p id="responseMsg"></p>
      </form>
      <br>
      <!-- üìà Progress Graph -->
<!-- üìà Progress Graphs -->
<div class="dashboard-card graph-container">
  <div class="graph-block">
    <h3>Weight Progress</h3>
    <canvas id="weightChart"></canvas>
  </div>
  <div class="graph-block">
    <h3>Waist Circumference</h3>
    <canvas id="waistChart"></canvas>
  </div>
</div>
  <button onclick="downloadChart('weightChart')" class="btn-secondary">‚¨áÔ∏è Download Weight Graph</button>
  <button onclick="downloadChart('waistChart')" class="btn-secondary">‚¨áÔ∏è Download Waist Graph</button>

  </section>

<div class="photo-upload-section">
  <h3>üì∏ Upload Progress Photos</h3>
  <input type="file" id="photoInput" accept="image/*" />
  <button id="uploadPhotoBtn" class="btn-primary">Upload Photo</button>
  <p id="uploadStatus"></p>
  <div id="photoGallery"></div>
</div>



<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    collection,
    addDoc,
    getDocs,
    Timestamp
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
  import {
    getStorage,
    ref as storageRef,
    uploadBytes,
    getDownloadURL,
    listAll
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

  document.addEventListener("DOMContentLoaded", async () => {
    const firebaseConfig = {
      apiKey: "AIzaSyDpju8JIedURVxBJgmZ1yBuRzd4CEdFDVY",
      authDomain: "carleynfitnesscalendar.firebaseapp.com",
      projectId: "carleynfitnesscalendar",
      storageBucket: "carleynfitnesscalendar.firebasestorage.app",
      messagingSenderId: "1013642078015",
      appId: "1:1013642078015:web:e8bcff9d1559f1c1d5158a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const form = document.getElementById("profile-form");
    const responseMsg = document.getElementById("responseMsg");
    const logoutBtn = document.getElementById("logoutBtn");

    const summaryCard = document.getElementById("summary-card");
    const userEmailDisplay = document.getElementById("user-email");

    const summaryName = document.getElementById("summary-name");
    const summaryGoal = document.getElementById("summary-goal");
    const summaryWeight = document.getElementById("summary-weight");

    const photoInput = document.getElementById("photoInput");
    const uploadPhotoBtn = document.getElementById("uploadPhotoBtn");
    const uploadStatus = document.getElementById("uploadStatus");
    const photoGallery = document.getElementById("photoGallery");

    let weightChart, waistChart;

    async function loadProgressData(uid) {
      const progressRef = collection(db, "clients", uid, "progress");
      const snapshot = await getDocs(progressRef);
      const weightData = [];
      const waistData = [];

      snapshot.forEach(doc => {
        const entry = doc.data();
        if (entry.date) {
          const date = new Date(entry.date.seconds * 1000);
          if (entry.weight) {
            weightData.push({ x: date, y: entry.weight });
          }
          if (entry.waist) {
            waistData.push({ x: date, y: entry.waist });
          }
        }
      });

      weightData.sort((a, b) => a.x - b.x);
      waistData.sort((a, b) => a.x - b.x);
      return { weightData, waistData };
    }

    function getAvgLine(dataArr, avgValue) {
      if (!dataArr.length) return [];
      return [
        { x: dataArr[0].x, y: avgValue },
        { x: dataArr[dataArr.length - 1].x, y: avgValue }
      ];
    }

    async function renderGraph(uid, startDate) {
      const { weightData, waistData } = await loadProgressData(uid);
      const avg = (arr) => arr.length ? (arr.reduce((sum, d) => sum + d.y, 0) / arr.length).toFixed(1) : null;

      const weightCtx = document.getElementById("weightChart").getContext("2d");
      const waistCtx = document.getElementById("waistChart").getContext("2d");

      if (weightChart instanceof Chart) weightChart.destroy();
      if (waistChart instanceof Chart) waistChart.destroy();

      const weightAvg = avg(weightData);
      const waistAvg = avg(waistData);

      weightChart = new Chart(weightCtx, {
        type: 'line',
        data: {
          datasets: [
            {
              label: 'Weight (kg)',
              data: weightData,
              borderColor: '#E91E63',
              backgroundColor: '#F8BBD0',
              fill: true,
              tension: 0.3,
              pointRadius: 4
            },
            {
              label: `Average Weight: ${weightAvg}kg`,
              data: getAvgLine(weightData, weightAvg),
              borderDash: [6, 6],
              borderColor: '#C2185B',
              pointRadius: 0,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { tooltip: { enabled: true }, legend: { position: 'top' } },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'week' },
            title: { display: true, text: 'Date' }
        },

            y: {
              title: { display: true, text: 'Weight (kg)' }
            }
          }
        }
      });

      waistChart = new Chart(waistCtx, {
        type: 'line',
        data: {
          datasets: [
            {
              label: 'Waist (cm)',
              data: waistData,
              borderColor: '#2196F3',
              backgroundColor: '#BBDEFB',
              fill: true,
              tension: 0.3,
              pointRadius: 4
            },
            {
              label: `Average Waist: ${waistAvg}cm`,
              data: getAvgLine(waistData, waistAvg),
              borderDash: [6, 6],
              borderColor: '#1565C0',
              pointRadius: 0,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { tooltip: { enabled: true }, legend: { position: 'top' } },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'week' },
              min: startDate || undefined,
              title: { display: true, text: 'Date' }
            },
            y: {
              title: { display: true, text: 'Waist (cm)' }
            }
          }
        }
      });
    }

    function downloadChart(chartId) {
      const canvas = document.getElementById(chartId);
      const link = document.createElement('a');
      link.download = `${chartId}.png`;
      link.href = canvas.toDataURL();
      link.click();
    }

    async function loadPhotos(uid) {
      photoGallery.innerHTML = "";
      const listRef = storageRef(storage, `clients/${uid}/photos`);
      try {
        const res = await listAll(listRef);
        const photoHTML = [];

        for (const item of res.items) {
          const url = await getDownloadURL(item);
          photoHTML.push(`
            <a href="${url}" class="glightbox" data-gallery="progress-photos">
              <img src="${url}" alt="Progress photo" class="photo-thumb"/>
            </a>
          `);
        }

        photoGallery.innerHTML = photoHTML.join("");
        GLightbox({ selector: ".glightbox" });
      } catch (err) {
        console.warn("No photos yet:", err.message);
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      userEmailDisplay.textContent = user.email;
      const docRef = doc(db, "clients", user.uid);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();

        document.getElementById("fullName").value = data.fullName || "";
        document.getElementById("goal").value = data.goal || "";
        document.getElementById("startDate").value = data.startDate || "";
        document.getElementById("currentWeight").value = data.currentWeight || "";
        document.getElementById("targetWeight").value = data.targetWeight || "";
        document.getElementById("waist").value = data.waist || "";
        document.getElementById("notes").value = data.notes || "";

        summaryCard.style.display = "block";
        summaryName.textContent = data.fullName || "Unknown";
        summaryGoal.textContent = data.goal || "None";

        if (data.currentWeight && data.targetWeight) {
          const diff = (data.currentWeight - data.targetWeight).toFixed(1);
          summaryWeight.textContent = `${data.currentWeight}kg ‚Üí ${data.targetWeight}kg (${diff}kg to go)`;
        } else {
          summaryWeight.textContent = "N/A";
        }
      }

      const startDate = docSnap.data().startDate ? new Date(docSnap.data().startDate) : null;
      await renderGraph(user.uid, startDate);
      await loadPhotos(user.uid);

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const profile = {
          fullName: document.getElementById("fullName").value,
          email: user.email,
          goal: document.getElementById("goal").value.trim(),
          startDate: document.getElementById("startDate").value,
          currentWeight: parseFloat(document.getElementById("currentWeight").value),
          targetWeight: parseFloat(document.getElementById("targetWeight").value),
          waist: parseFloat(document.getElementById("waist").value),
          notes: document.getElementById("notes").value.trim()
        };

        try {
          await setDoc(docRef, profile);
          await addDoc(collection(db, "clients", user.uid, "progress"), {
            weight: profile.currentWeight,
            waist: profile.waist,
            date: Timestamp.now()
          });

          responseMsg.style.color = "green";
          responseMsg.textContent = "‚úÖ Profile updated!";
          await renderGraph(user.uid);
        } catch (err) {
          console.error(err);
          responseMsg.style.color = "red";
          responseMsg.textContent = "‚ùå Error saving profile.";
        }
      });

      uploadPhotoBtn.addEventListener("click", async () => {
        if (!photoInput.files.length) return;
        const file = photoInput.files[0];
        const fileRef = storageRef(storage, `clients/${user.uid}/photos/${Date.now()}_${file.name}`);

        try {
          await uploadBytes(fileRef, file);
          uploadStatus.textContent = "‚úÖ Photo uploaded!";
          uploadStatus.style.color = "green";
          await loadPhotos(user.uid);
        } catch (err) {
          console.error(err);
          uploadStatus.textContent = "‚ùå Upload failed!";
          uploadStatus.style.color = "red";
        }
      });
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "index.html";
    });

  });
</script>


</body>
</html>
