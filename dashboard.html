<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="images/CNF_Dashboard.png" type="image/png">
  <!-- Chart.js kept in case you re-enable graphs later -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/glightbox/3.2.0/css/glightbox.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/glightbox/3.2.0/js/glightbox.min.js"></script>
  <style>
    /* Optional: small style for coach notes */
    .coach-note { margin: 6px 0 10px; font-size: 0.95rem; opacity: 0.9; }
    .coach-note strong { white-space: nowrap; }
    #dailySummary li { margin-bottom: 10px; }
  </style>
</head>
<body>

<section class="section" style="max-width: 700px; margin-top: 60px;">
  <div class="container">
    <h2>Welcome to Your Fitness Dashboard</h2>

    <!-- üîπ Summary Card (kept) -->
    <div class="dashboard-card" id="summary-card" style="display: none;">
      <h3>Summary</h3>
      <p><strong>Name:</strong> <span id="summary-name"></span></p>
      <p><strong>Goal:</strong> <span id="summary-goal"></span></p>
      <p><strong>Weight Progress:</strong>
        <span id="summary-weight"></span>
      </p>
    </div>

    <!-- üîπ Coach Carley Weekly Note (separate card) -->
<div class="dashboard-card" id="coach-card" style="display:none; margin-bottom:16px;">
  <div style="display:flex; gap:14px; align-items:center;">
    <img id="coachPhoto" src="images/coachphoto.jpg" alt="Coach Carley"
         style="width:56px; height:56px; object-fit:cover; border-radius:9999px; flex:0 0 56px;" />
    <div>
      <h3 style="margin:0 0 4px;">Coach Carley‚Äôs Note</h3>
      <div id="coachWeeklyNoteTop" class="coach-note" style="margin:0;"></div>
    </div>
  </div>
</div>


    <!-- üîπ Daily Summary with Coach Notes -->
    <div class="dashboard-card" id="daily-summary-card" style="display:none;">
      <h3>üóìÔ∏è Daily Summary (last 7 days)</h3>
      <p id="weeklyHeadline"></p>
      <ul id="dailySummary" style="list-style:none; padding-left:0;"></ul>
    </div>

    <!-- üîπ Logs -->
    <details class="log-section">
      <summary><strong>üèãÔ∏è Workout Log</strong></summary>
      <form id="workoutLogForm">
        <label for="workoutDate">Date</label>
        <input type="date" id="workoutDate" required />

        <label for="workoutType">Type</label>
        <select id="workoutType">
          <option>Strength</option>
          <option>Cardio</option>
          <option>Mobility</option>
          <option>Other</option>
        </select>

        <label for="duration">Duration (mins)</label>
        <input type="number" id="duration" min="5" required />

        <label for="workoutNotes">Notes (optional)</label>
        <textarea id="workoutNotes"></textarea>

        <button class="btn-primary" type="submit">Log Workout</button>
      </form>
    </details>

    <details class="log-section">
      <summary><strong>üçΩÔ∏è Meal Macros Log</strong></summary>
      <form id="mealLogForm">
        <label for="mealDate">Date</label>
        <input type="date" id="mealDate" required />

        <label for="calories">Calories</label>
        <input type="number" id="calories" required />

        <label for="protein">Protein (g)</label>
        <input type="number" id="protein" required />

        <label for="carbs">Carbs (g)</label>
        <input type="number" id="carbs" required />

        <label for="fat">Fat (g)</label>
        <input type="number" id="fat" required />

        <label for="fibre">Fibre (g)</label>
        <input type="number" id="fibre" />

        <button class="btn-primary" type="submit">Log Meal</button>
      </form>
    </details>

    <!-- üîß Profile -->
    <form id="profile-form">
      <p><strong>Email:</strong> <span id="user-email"></span></p>

      <details class="profile-section">
        <summary><strong>üìù Generic Information</strong></summary>
        <label for="fullName">Full Name</label>
        <input type="text" id="fullName" readonly />

        <label for="goal">Goal</label>
        <input type="text" id="goal" />

        <label for="calorieTarget">Calorie Target (kcal)</label>
        <input type="number" id="calorieTarget" min="800" max="4000" step="10" placeholder="e.g. 1200" />

        <label for="startDate">Goal Start Date</label>
        <input type="date" id="startDate" />
        <label for="notes">Notes</label>
<textarea id="notes"></textarea>

<button type="submit" class="btn-primary">üíæ Save Changes</button>
<p id="responseMsg"></p>
      </details>
    </form>
      <!-- üìä Body Metrics (kept for profile only; progress bars removed) -->
      <details class="metrics-section" open>
  <summary><strong>üìä Body Metrics (daily)</strong></summary>

  <form id="dailyMetricsForm">
    <div style="display:flex; gap:12px; align-items:end; margin:8px 0 12px;">
      <div>
        <label for="metricsDate">Date</label>
        <input type="date" id="metricsDate" required />
      </div>
      <button type="button" id="loadMetricsBtn" class="btn-secondary">Load for date</button>
      <button type="submit" class="btn-primary">üíæ Save Daily Metrics</button>
      <span id="metricsMsg" style="margin-left:8px; font-size:0.95rem;"></span>
    </div>
</form>
    <table class="metrics-table">
      <thead>
        <tr>
          <th>Metric</th>
          <th>Value</th>
          <th>Target (profile)</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>Weight (kg/lbs)</td><td><input type="number" id="weight" step="0.1" /></td><td><input type="number" id="targetWeight" step="0.1" /></td></tr>
        <tr><td>Waist (cm)</td><td><input type="number" id="waist" step="0.1" /></td><td><input type="number" id="targetWaist" step="0.1" /></td></tr>
        <tr><td>Hip (cm)</td><td><input type="number" id="hip" step="0.1" /></td><td><input type="number" id="targetHip" step="0.1" /></td></tr>
        <tr><td>Chest (cm)</td><td><input type="number" id="chest" step="0.1" /></td><td><input type="number" id="targetChest" step="0.1" /></td></tr>
        <tr><td>Thigh (cm)</td><td><input type="number" id="thigh" step="0.1" /></td><td><input type="number" id="targetThigh" step="0.1" /></td></tr>
        <tr><td>Arm (cm)</td><td><input type="number" id="arm" step="0.1" /></td><td><input type="number" id="targetArm" step="0.1" /></td></tr>
        <tr><td>Glutes (cm)</td><td><input type="number" id="glutes" step="0.1" /></td><td><input type="number" id="targetGlutes" step="0.1" /></td></tr>
      </tbody>
    </table>

  <div id="metricsHistory" style="margin-top:10px;">
    <h4 style="margin:12px 0 6px;">Recent entries</h4>
    <ul id="metricsHistoryList" style="list-style:none; padding-left:0; margin:0;"></ul>
  </div>
</details>


<div class="photo-upload-section">
  <h3>üì∏ Upload Progress Photos</h3>
  <input type="file" id="photoInput" accept="image/*" />
  <button id="uploadPhotoBtn" class="btn-primary">Upload Photo</button>
  <p id="uploadStatus"></p>
  <div id="photoGallery"></div>
</div>

<button id="logoutBtn" class="btn-secondary">üö™ Logout</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs, Timestamp,
  query, orderBy, limit, arrayUnion
} from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
import {
  getStorage, ref as storageRef, uploadBytes, getDownloadURL, listAll
} from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

document.addEventListener("DOMContentLoaded", async () => {
  const firebaseConfig = {
    apiKey: "AIzaSyDpju8JIedURVxBJgmZ1yBuRzd4CEdFDVY",
    authDomain: "carleynfitnesscalendar.firebaseapp.com",
    projectId: "carleynfitnesscalendar",
    storageBucket: "carleynfitnesscalendar.firebasestorage.app",
    messagingSenderId: "1013642078015",
    appId: "1:1013642078015:web:e8bcff9d1559f1c1d5158a"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const form = document.getElementById("profile-form");
  const responseMsg = document.getElementById("responseMsg");
  const logoutBtn = document.getElementById("logoutBtn");

  const summaryCard = document.getElementById("summary-card");
  const userEmailDisplay = document.getElementById("user-email");
  const summaryName = document.getElementById("summary-name");
  const summaryGoal = document.getElementById("summary-goal");
  const summaryWeight = document.getElementById("summary-weight");

  const dailySummaryCard = document.getElementById("daily-summary-card");
  const weeklyHeadline = document.getElementById("weeklyHeadline");
  const dailySummaryList = document.getElementById("dailySummary");

  const photoInput = document.getElementById("photoInput");
  const uploadPhotoBtn = document.getElementById("uploadPhotoBtn");
  const uploadStatus = document.getElementById("uploadStatus");
  const photoGallery = document.getElementById("photoGallery");

  const metricFields = ["weight", "waist", "hip", "chest", "thigh", "arm", "glutes"];

  // ======= Configurable thresholds for Coach notes =======
  const PROTEIN_STRONG = 100;     // g
  const FIBRE_GOOD = 25;          // g
  const CAL_TARGET = 1200;        // kcal (fallback if no profile target exists)
  const CAL_TOL = 150;            // ¬± range considered ‚Äúon target‚Äù

  // Helper: today default for date inputs
  function todayStr() {
    const tz = new Date();
    const yyyy = tz.getFullYear();
    const mm = String(tz.getMonth() + 1).padStart(2, "0");
    const dd = String(tz.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  // Initialise date inputs to today
  const workoutDateInput = document.getElementById("workoutDate");
  const mealDateInput = document.getElementById("mealDate");
  if (workoutDateInput) workoutDateInput.value = todayStr();
  if (mealDateInput) mealDateInput.value = todayStr();

  function getValue(id) {
    const val = parseFloat(document.getElementById(id)?.value);
    return isNaN(val) ? null : val;
  }

  async function saveProgress(uid, metrics) {
    const progressRef = collection(db, "clients", uid, "progress");
    await addDoc(progressRef, {
      ...metrics,
      date: Timestamp.now()
    });
  }

  function toDateTS(dateStr) {
    const d = new Date(dateStr + "T00:00:00");
    return Timestamp.fromDate(d);
  }

  // === NEW: Build emoji summary + coach notes ===
  async function renderDailySummary(uid, days = 7, calorieTargetOverride) {
  const wRef = collection(db, "clients", uid, "workoutsDaily");
  const mRef = collection(db, "clients", uid, "mealsDaily");
  const wSnap = await getDocs(query(wRef, orderBy("dateTS", "desc"), limit(21)));
  const mSnap = await getDocs(query(mRef, orderBy("dateTS", "desc"), limit(21)));

  const workoutsByDay = {};
  wSnap.forEach(d => {
    const data = d.data() || {};
    workoutsByDay[d.id] = data.entries || []; // d.id = YYYY-MM-DD
  });

  const mealsByDay = {};
  mSnap.forEach(d => {
    mealsByDay[d.id] = d.data() || {};
  });

  // Last N calendar days up to today (inclusive)
  const daysList = [];
  const today = new Date();
  for (let i = 0; i < days; i++) {
    const d = new Date(today);
    d.setDate(today.getDate() - i);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    daysList.push(`${yyyy}-${mm}-${dd}`);
  }

  const calTarget = calorieTargetOverride ?? CAL_TARGET;

  // Aggregate stats
  let totalWorkouts = 0;
  let totalWorkoutMinutes = 0;
  let highProteinDays = 0;
  let fibreGoodDays = 0;
  let onTargetCalDays = 0;
  let daysWithMeals = 0;

  const proteinVals = [];
  const calorieVals = [];

  dailySummaryList.innerHTML = "";

  daysList.forEach(day => {
    const w = workoutsByDay[day] || [];
    const m = mealsByDay[day];

    // Emoji line (no per-day notes anymore)
    const hasWorkout = w.length > 0;
    const totalMins = w.reduce((s, e) => s + (parseInt(e.duration) || 0), 0);
    const emojis = [];

    if (hasWorkout) {
      totalWorkouts += 1;
      totalWorkoutMinutes += totalMins;
      emojis.push(`üèãÔ∏è ${totalMins}m`);
    } else {
      emojis.push(`üèãÔ∏è‚Äî`);
    }

    if (m && typeof m.calories === "number") {
      calorieVals.push(m.calories);
      daysWithMeals += 1;
      if (Math.abs(m.calories - calTarget) <= CAL_TOL) onTargetCalDays += 1;
    }
    if (m && typeof m.protein === "number") {
      proteinVals.push(m.protein);
      if (m.protein >= PROTEIN_STRONG) highProteinDays += 1;
      emojis.push(`üçó ${m.protein}g${m.protein >= PROTEIN_STRONG ? " üí™" : ""}`);
    } else {
      emojis.push("üçó‚Äî");
    }

    if (m && typeof m.fibre === "number" && m.fibre >= FIBRE_GOOD) {
      fibreGoodDays += 1;
      emojis.push("üåø");
    }

    if (m && typeof m.calories === "number") emojis.push(`üçΩÔ∏è ${m.calories}kcal`);
    else emojis.push("üçΩÔ∏è‚Äî");

    const li = document.createElement("li");
    li.textContent = `${day}: ${emojis.join("  ‚Ä¢  ")}`;
    dailySummaryList.appendChild(li);
  });

  const avg = arr => arr.length ? Math.round(arr.reduce((a,b)=>a+b,0) / arr.length) : 0;

  // Headline
  const headline = `This week: ${totalWorkouts}√ó üèãÔ∏è ‚Ä¢ ${totalWorkoutMinutes} mins total ‚Ä¢ avg üçó ${avg(proteinVals)}g ‚Ä¢ avg üçΩÔ∏è ${avg(calorieVals)} kcal`;
  weeklyHeadline.textContent = headline;

  // Weekly coach note
  const coachWeekly = coachWeeklyNote({
    totalWorkouts,
    totalWorkoutMinutes,
    highProteinDays,
    fibreGoodDays,
    onTargetCalDays,
    daysWithMeals,
    avgProtein: avg(proteinVals),
    avgCalories: avg(calorieVals),
    daysConsidered: days,
    calTarget,
  });

const coachEl = document.getElementById("coachWeeklyNoteTop") || document.getElementById("coachWeeklyNote");
if (coachEl) coachEl.textContent = coachWeekly;

const coachCard = document.getElementById("coach-card");
if (coachCard) coachCard.style.display = "block";

const dailySummaryCardEl = document.getElementById("daily-summary-card");
if (dailySummaryCardEl) dailySummaryCardEl.style.display = "block";

  }
// One witty, encouraging note for the week-to-date
function coachWeeklyNote(stats) {
  const {
    totalWorkouts, totalWorkoutMinutes,
    highProteinDays, fibreGoodDays,
    onTargetCalDays, daysWithMeals,
    avgProtein, avgCalories,
    daysConsidered, calTarget
  } = stats;

  // Quick helpers
  const goodProtein = avgProtein >= PROTEIN_STRONG;
  const goodCals = Math.abs(avgCalories - calTarget) <= CAL_TOL;

  // Tiered logic
  if (totalWorkouts >= 5 && goodProtein && goodCals) {
    return "Coach Carley: If consistency had a face, it‚Äôd be yours. Programme directors are asking for your autograph. üíºüí™";
  }
  if (totalWorkouts >= 4 && (goodProtein || goodCals)) {
    return "Coach Carley: High-output week. The only thing you‚Äôre missing is a victory soundtrack. üé∂";
  }
  if (totalWorkouts >= 3) {
    if (goodProtein) return "Coach Carley: Solid training volume and protein to match. Muscles are sending thank-you notes. üì¨";
    if (goodCals)    return "Coach Carley: Training + calorie control = momentum. Keep the cart rolling. üõí‚û°Ô∏è";
    return "Coach Carley: Three+ sessions in the bag. Let‚Äôs pair that with sharper nutrition and go again. üîÅ";
  }
  if (totalWorkouts >= 1) {
    if (goodProtein || highProteinDays >= Math.ceil(daysConsidered/2)) {
      return "Coach Carley: Training showed up and protein followed. That‚Äôs the duet we like. üé§";
    }
    if (goodCals || onTargetCalDays >= Math.ceil(daysConsidered/2)) {
      return "Coach Carley: Calories mostly on target. Add one more workout and it‚Äôs chef‚Äôs kiss. üë©‚Äçüç≥";
    }
    return "Coach Carley: Spark found. Now we pour it on‚Äîtwo more sessions and the week flips. üî•";
  }

  // No workouts logged this week
  if (daysWithMeals > 0 && (goodProtein || goodCals)) {
    return "Coach Carley: Nutrition‚Äôs doing the heavy lifting. Your shoes miss you though. üëü";
  }

  // Default nudge
  return "Coach Carley: Quiet week so far. Consider this your gentle shoulder tap‚Äîlet‚Äôs make today count. üëâ";
}

const METRIC_FIELDS = ["weight", "waist", "hip", "chest", "thigh", "arm", "glutes"];

function metricsDateToday() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

function readMetricsFromForm() {
  const result = {};
  METRIC_FIELDS.forEach(k => {
    const v = document.getElementById(k)?.value;
    result[k] = v !== "" && v != null ? parseFloat(v) : null;
  });
  return result;
}

function writeMetricsToForm(obj = {}) {
  METRIC_FIELDS.forEach(k => {
    const el = document.getElementById(k);
    if (!el) return;
    const v = obj[k];
    el.value = (typeof v === "number" && !Number.isNaN(v)) ? v : "";
  });
}

async function saveDailyMetrics(db, uid, dateStr) {
  const metrics = readMetricsFromForm();
  const dailyRef = doc(db, "clients", uid, "metricsDaily", dateStr);
  await setDoc(dailyRef, {
    date: dateStr,
    dateTS: toDateTS(dateStr),
    ...metrics,
    savedAt: Timestamp.now()
  }, { merge: true });
}

async function loadDailyMetrics(db, uid, dateStr) {
  const dailyRef = doc(db, "clients", uid, "metricsDaily", dateStr);
  const snap = await getDoc(dailyRef);
  return snap.exists() ? snap.data() : null;
}

async function loadRecentMetrics(db, uid, n = 7) {
  const col = collection(db, "clients", uid, "metricsDaily");
  const qs = await getDocs(query(col, orderBy("dateTS", "desc"), limit(n)));
  const out = [];
  qs.forEach(docu => out.push({ id: docu.id, ...docu.data() }));
  return out;
}

    

  onAuthStateChanged(auth, async (user) => {
    if (!user) return window.location.href = "login.html";
    userEmailDisplay.textContent = user.email;

    const docRef = doc(db, "clients", user.uid);
    const docSnap = await getDoc(docRef);
    const data = docSnap.data() || {};

    // Populate profile
    document.getElementById("fullName").value = data.fullName || "";
    document.getElementById("goal").value = data.goal || "";
    document.getElementById("startDate").value = data.startDate || "";
    document.getElementById("notes").value = data.notes || "";
    document.getElementById("calorieTarget").value =
      typeof data.calorieTarget === "number" ? data.calorieTarget : "";

// === Daily Body Metrics ===
const metricsDateInput = document.getElementById("metricsDate");
const metricsMsg = document.getElementById("metricsMsg");
const loadMetricsBtn = document.getElementById("loadMetricsBtn");
const dailyMetricsForm = document.getElementById("dailyMetricsForm");

if (metricsDateInput) metricsDateInput.value = metricsDateToday();

// Load for date button
if (loadMetricsBtn) {
  loadMetricsBtn.addEventListener("click", async () => {
    const dateStr = metricsDateInput.value || metricsDateToday();
    const rec = await loadDailyMetrics(db, user.uid, dateStr);
    if (rec) {
      writeMetricsToForm(rec);
      metricsMsg.textContent = `üìÖ Loaded metrics for ${dateStr}`;
      metricsMsg.style.color = "inherit";
    } else {
      writeMetricsToForm({});
      metricsMsg.textContent = `‚ÑπÔ∏è No metrics saved for ${dateStr} (fields cleared).`;
      metricsMsg.style.color = "inherit";
    }
  });
}

// Save daily metrics (submit)
if (dailyMetricsForm) {
  dailyMetricsForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const dateStr = metricsDateInput.value || metricsDateToday();
    try {
      await saveDailyMetrics(db, user.uid, dateStr);
      metricsMsg.textContent = "‚úÖ Daily metrics saved!";
      metricsMsg.style.color = "green";
      // Refresh recent history list
      await renderRecentMetricsHistory();
    } catch (err) {
      console.error(err);
      metricsMsg.textContent = "‚ùå Error saving daily metrics.";
      metricsMsg.style.color = "red";
    }
  });
}

// Show last 7 entries under the form
async function renderRecentMetricsHistory() {
  const listEl = document.getElementById("metricsHistoryList");
  if (!listEl) return;
  listEl.innerHTML = "";
  const rows = await loadRecentMetrics(db, user.uid, 7);
  rows.forEach(r => {
    const parts = [];
    if (typeof r.weight === "number") parts.push(`‚öñÔ∏è ${r.weight}`);
    if (typeof r.waist === "number")  parts.push(`üìè ${r.waist}`);
    if (typeof r.hip === "number")    parts.push(`üßµ hip ${r.hip}`);
    const li = document.createElement("li");
    li.textContent = `${r.id}: ${parts.length ? parts.join(" ‚Ä¢ ") : "‚Äî"}`;
    listEl.appendChild(li);
  });
}
await renderRecentMetricsHistory();



    // Keep metrics in profile (no progress bars)
    metricFields.forEach(metric => {
      const input = document.getElementById(metric);
      const targetInput = document.getElementById(`target${metric.charAt(0).toUpperCase()}${metric.slice(1)}`);
      if (input) input.value = data[metric] ?? "";
      if (targetInput) targetInput.value = data[`target${metric.charAt(0).toUpperCase()}${metric.slice(1)}`] ?? "";
    });

    summaryCard.style.display = "block";
    summaryName.textContent = data.fullName || "Unknown";
    summaryGoal.textContent = data.goal || "None";
    if (data.weight && data.targetWeight) {
      const diff = (data.weight - data.targetWeight).toFixed(1);
      summaryWeight.textContent = `${data.weight}kg ‚Üí ${data.targetWeight}kg (${diff}kg to go)`;
    } else {
      summaryWeight.textContent = "N/A";
    }

    // === üèãÔ∏è Workout Log (per calendar day) ===
    const workoutForm = document.getElementById("workoutLogForm");
    if (workoutForm) {
      workoutForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const dateStr = document.getElementById("workoutDate").value || todayStr();

        const log = {
          type: document.getElementById("workoutType").value,
          duration: parseInt(document.getElementById("duration").value),
          notes: document.getElementById("workoutNotes").value || "",
          loggedAt: Timestamp.now()
        };

        // Save under workoutsDaily/{YYYY-MM-DD} with entries array
        const dailyRef = doc(db, "clients", user.uid, "workoutsDaily", dateStr);
        await setDoc(dailyRef, {
          date: dateStr,
          dateTS: toDateTS(dateStr),
          entries: arrayUnion(log)
        }, { merge: true });

        alert("‚úÖ Workout logged!");
        await renderDailySummary(user.uid, 7, data.calorieTarget);
      });
    }

    // === üçΩÔ∏è Meal Macros Log (per calendar day) ===
    document.getElementById("mealLogForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const dateStr = document.getElementById("mealDate").value || todayStr();
      const log = {
        date: dateStr,
        dateTS: toDateTS(dateStr),
        calories: parseInt(document.getElementById("calories").value),
        protein: parseInt(document.getElementById("protein").value),
        carbs: parseInt(document.getElementById("carbs").value),
        fat: parseInt(document.getElementById("fat").value),
        fibre: document.getElementById("fibre").value ? parseInt(document.getElementById("fibre").value) : null,
        loggedAt: Timestamp.now()
      };

      // Save/overwrite the day's macros
      const dailyRef = doc(db, "clients", user.uid, "mealsDaily", dateStr);
      await setDoc(dailyRef, log, { merge: true });

      alert("‚úÖ Meal macros logged!");
      await renderDailySummary(user.uid, 7, data.calorieTarget);
    });

    // Profile save (kept; progress bars removed)
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const ctRaw = document.getElementById("calorieTarget").value;
      const ct = ctRaw ? parseInt(ctRaw) : null;
      const profile = {
        fullName: document.getElementById("fullName").value,
        email: user.email,
        goal: document.getElementById("goal").value,
        startDate: document.getElementById("startDate").value,
        notes: document.getElementById("notes").value,
        calorieTarget: ct
      };

      const previousStartDate = data.startDate || "";
      const goalStartDate = profile.startDate;
      const goalDateChanged = previousStartDate !== goalStartDate;

      const metrics = {};
      metricFields.forEach(metric => {
        const val = getValue(metric);
        metrics[metric] = val;
        profile[metric] = val;

        const cap = metric.charAt(0).toUpperCase() + metric.slice(1);
        const targetKey = `target${cap}`;
        const startingKey = `starting${cap}`;

        profile[targetKey] = getValue(targetKey);
        profile[startingKey] = goalDateChanged ? val : (data[startingKey] ?? val);
      });

      try {
        await setDoc(docRef, profile, { merge: true });
        await saveProgress(user.uid, metrics);
        responseMsg.textContent = "‚úÖ Profile updated!";
        responseMsg.style.color = "green";
        await renderDailySummary(user.uid, 7, profile.calorieTarget);
      } catch (err) {
        console.error(err);
        responseMsg.textContent = "‚ùå Error saving profile.";
        responseMsg.style.color = "red";
      }
    });

    // Photos
    async function loadPhotos(uid) {
      photoGallery.innerHTML = "";
      const listRef = storageRef(storage, `clients/${uid}/photos`);
      try {
        const res = await listAll(listRef);
        for (const item of res.items) {
          const url = await getDownloadURL(item);
          const a = document.createElement("a");
          a.href = url;
          a.className = "glightbox";
          a.dataset.gallery = "progress-photos";
          a.innerHTML = `<img src="${url}" alt="Progress photo" class="photo-thumb"/>`;
          photoGallery.appendChild(a);
        }
        GLightbox({ selector: ".glightbox" });
      } catch (err) {
        console.warn("No photos yet:", err.message);
      }
    }

    document.getElementById("uploadPhotoBtn").addEventListener("click", async () => {
      if (!photoInput.files.length) return;
      const file = photoInput.files[0];
      const fileRef = storageRef(storage, `clients/${user.uid}/photos/${Date.now()}_${file.name}`);

      try {
        await uploadBytes(fileRef, file);
        uploadStatus.textContent = "‚úÖ Photo uploaded!";
        uploadStatus.style.color = "green";
        await loadPhotos(user.uid);
      } catch (err) {
        console.error(err);
        uploadStatus.textContent = "‚ùå Upload failed!";
        uploadStatus.style.color = "red";
      }
    });

    await loadPhotos(user.uid);

    // Initial summary load
    await renderDailySummary(user.uid, 7, data.calorieTarget);
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "index.html";
  });
});
</script>

</body>
</html>
